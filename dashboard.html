<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QC Dashboard</title>
<!-- Tailwind CSS -->
<script src="https://www.google.com/search?q=https://cdn.tailwindcss.com"></script>
<!-- Lucide Icons -->
<script src="https://www.google.com/search?q=https://unpkg.com/lucide-react%400.395.0/dist/umd/lucide.js"></script>
<!-- Firebase Libraries -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'header-blue': '#2563eb', // blue-600
                    'button-dark': '#1f2937', // gray-800
                    'button-light': '#3b82f6', // blue-500
                }
            }
        }
    }
</script>

<style>
    body { font-family: 'Inter', sans-serif; }
    .text-yellow-custom { color: #d97706; font-weight: bold; background: #fef3c7; padding: 0 4px; border-radius: 2px; } 
    .text-red-custom { color: #dc2626; font-weight: bold; background: #fee2e2; padding: 0 4px; border-radius: 2px; }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    
    #details-modal { transition: opacity 0.3s ease; }
    #details-modal-content { transition: transform 0.3s ease; transform: scale(0.95); }
    #details-modal:not(.hidden) #details-modal-content { transform: scale(1); }
</style>

</head>
<body class="bg-slate-100 text-slate-800">
<!-- 1. Login Modal -->
<div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm mx-4">
        <h3 class="text-xl font-bold text-gray-800 text-center mb-4">Mrs. Sparkle</h3>
        <p class="text-center text-gray-600 mb-6">Manager Dashboard Login</p>
        <input type="email" id="email-input" placeholder="Email..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm transition-shadow">
        <input type="password" id="password-input" placeholder="Password..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm transition-shadow mt-2">
        <button id="unlock-button" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold mt-4 hover:bg-blue-700 transition-colors shadow-md">
            Sign In
        </button>
        <p id="error-msg" class="text-red-600 text-sm mt-3 text-center hidden font-medium"></p>
    </div>
</div>

<!-- 2. App Container (Hidden by default) -->
<div id="app-container" class="hidden opacity-0 transition-opacity duration-500 min-h-screen bg-slate-100">
    
    <!-- Navbar -->
    <nav class="bg-primary text-white px-4 py-3 shadow-lg sticky top-0 z-40">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="p-1.5 bg-white/20 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 10h18M3 6h18M3 14h18M3 18h18"></path></svg></div>
                <span class="font-bold tracking-wide">Manager Dashboard</span>
            </div>
            <div>
                <span id="user-email" class="text-sm text-blue-100 mr-4"></span>
                <button id="logout-button" title="Logout" class="p-2 text-primaryLight hover:text-white hover:bg-white/10 rounded-full transition-all">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto p-4">
        
        <h2 class="text-xl font-bold text-slate-700 mb-4">Recent Submissions</h2>
        
        <div id="loading-state" class="text-center py-10">
            <p class="text-lg text-slate-500">Loading submissions...</p>
        </div>
        <div id="empty-state" class="hidden text-center py-10 bg-white rounded-lg shadow-sm">
            <p class="text-lg text-slate-500">No submissions found.</p>
            <p class="text-sm text-slate-400">New assessments from inspectors will appear here automatically.</p>
        </div>

        <div id="submissions-list" class="space-y-3">
            <!-- Submissions will be injected here -->
        </div>
    </main>
</div>

<!-- 3. Details Modal (Hidden by default) -->
<div id="details-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-70 flex items-start justify-center z-50 p-4 overflow-y-auto" onclick="App.closeModal()">
    <div id="details-modal-content" class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg mx-4 my-8" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4 pb-4 border-b">
            <h3 class="text-lg font-bold text-primaryDark" id="modal-client-name">Client Details</h3>
            <button onclick="App.closeModal()" class="text-slate-400 hover:text-slate-600 text-3xl leading-none">&times;</button>
        </div>
        <div id="modal-body" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
            <!-- Details will be injected here -->
        </div>
    </div>
</div>

<!-- 4. App Logic (Vanilla JS) -->
<script>
    // --- (YOUR FIREBASE CONFIG) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDyuCbPWKCcWYqPCcxW92wE2nZFUu_hC-c",
      authDomain: "mrs-sparkles-qc-app.firebaseapp.com",
      projectId: "mrs-sparkles-qc-app",
      storageBucket: "mrs-sparkles-qc-app.firebasestorage.app",
      messagingSenderId: "692678390922",
      appId: "1:692678390922:web:7cb5b1275e334f9fb0a973"
    };

    // --- (GLOBAL VARS) ---
    let db; 
    let auth;
    let unsubscribe; 

    // --- (HELPER FUNCTIONS) ---
    function h(tag, attrs = {}, children = []) {
        const el = document.createElement(tag);
        for (const key in attrs) {
            if (key.startsWith('on') && typeof attrs[key] === 'function') {
                el.addEventListener(key.substring(2).toLowerCase(), attrs[key]);
            } else { el.setAttribute(key, attrs[key]); }
        }
        children.forEach(child => {
            if (typeof child === 'string' || typeof child === 'number') {
                el.appendChild(document.createTextNode(child));
            } else if (child) { el.appendChild(child); }
        });
        return el;
    }
    
    function formatNotes(text) {
        if (!text) return [h('span', {}, ['N/A'])];
        const parts = text.split(/(\*[^*]+\*|#[^#]+#)/g);
        return parts.map((part, index) => {
            if (part.startsWith('*') && part.endsWith('*')) {
                return h('span', { class: 'text-yellow-custom' }, [part.slice(1, -1)]);
            } else if (part.startsWith('#') && part.endsWith('#')) {
                return h('span', { class: 'text-red-custom' }, [part.slice(1, -1)]);
            } else { return h('span', {}, [part]); }
        });
    }
    
    function formatDate(isoString) {
        if (!isoString) return 'N/A';
        try {
            return new Date(isoString).toLocaleString('en-US', { 
                year: 'numeric', month: 'short', day: 'numeric', 
                hour: 'numeric', minute: '2-digit' 
            });
        } catch (e) { return isoString; }
    }
    
    // --- (MAIN DASHBOARD LOGIC) ---
    const App = {
        init() {
            lucide.createIcons();
            document.getElementById('logout-button').onclick = () => {
                auth.signOut(); // This will trigger the onAuthStateChanged listener
            };
            this.fetchSubmissions();
        },
        
        fetchSubmissions() {
            const loading = document.getElementById('loading-state');
            const empty = document.getElementById('empty-state');
            const list = document.getElementById('submissions-list');
            
            loading.classList.remove('hidden');
            empty.classList.add('hidden');
            list.innerHTML = '';
            
            if (unsubscribe) unsubscribe(); 
            
            try {
                unsubscribe = db.collection('checklists') // Make sure this matches Inspector App
                    .orderBy('submittedAt', 'desc')
                    .onSnapshot(querySnapshot => {
                        loading.classList.add('hidden');
                        if (querySnapshot.empty) {
                            empty.classList.remove('hidden');
                            list.innerHTML = '';
                        } else {
                            empty.classList.add('hidden');
                            list.innerHTML = ''; 
                            querySnapshot.forEach(doc => {
                                const data = doc.data();
                                data.id = doc.id; 
                                list.appendChild(this.createSubmissionCard(data));
                            });
                        }
                    }, err => {
                        console.error("Error fetching data: ", err);
                        loading.classList.add('hidden');
                        list.innerHTML = `<p class="text-red-500">Error: ${err.message}</p>`;
                    });
                    
            } catch (e) {
                console.error("Firestore error: ", e);
                loading.classList.add('hidden');
                list.innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`;
            }
        },
        
        createSubmissionCard(data) {
            const client = data.client || {};
            
            return h('div', { 
                class: 'bg-white rounded-lg shadow-sm border border-slate-200 p-4 flex justify-between items-center cursor-pointer hover:shadow-md transition-shadow',
                onClick: () => this.showDetails(data)
            }, [
                h('div', { class: 'flex-1' }, [
                    h('p', { class: 'font-bold text-lg text-primary' }, [client.name || 'No Name']),
                    h('p', { class: 'text-sm text-slate-500' }, [client.address || 'No Address']),
                    h('p', { class: 'text-xs text-slate-400 pt-1' }, [`Submitted by: ${data.inspectorEmail || 'unknown'}`]),
                ]),
                h('div', { class: 'text-right flex-shrink-0 ml-4' }, [
                    h('p', { class: 'text-sm font-medium text-slate-600' }, [formatDate(data.submittedAt)]),
                    h('span', { class: 'text-xs font-bold px-2 py-0.5 rounded-full bg-primaryLight text-primary' }, [data.id.substring(0, 6)])
                ])
            ]);
        },
        
        showDetails(data) {
            document.getElementById('modal-client-name').textContent = (data.client || {}).name || 'Submission Details';
            const body = document.getElementById('modal-body');
            body.innerHTML = ''; 
            
            const { client = {}, sections = [], site = {}, signatureDataURL } = data;
            
            const addSection = (title, details) => {
                body.appendChild(h('h4', { class: 'text-sm font-bold text-slate-400 uppercase tracking-wider mt-2' }, [title]));
                body.appendChild(h('div', { class: 'bg-slate-50 p-3 rounded-lg border' }, details));
            };
            
            const addDetail = (label, value) => h('div', { class: 'flex justify-between text-sm py-1.5 border-b border-slate-200 last:border-b-0' }, [
                h('span', { class: 'text-slate-600' }, [label]),
                h('span', { class: 'font-semibold text-slate-800 text-right' }, [value || 'N/A']),
            ]);

            // Client Details
            addSection('Client Details', [
                addDetail('Name', client.name),
                addDetail('Address', client.address),
                addDetail('Appt. Date', formatDate(client.apptDate)), // Assuming this exists
            ]);
            
            // Checklist
            sections.forEach(section => {
                if (!section.tasks) return;
                const taskDetails = section.tasks.map(task => 
                    h('div', { class: 'flex items-center text-sm py-1' }, [
                        h('span', { class: 'mr-2' }, [task.checked ? '✔' : '☐']),
                        h('span', { class: task.checked ? 'text-slate-800' : 'text-slate-500' }, [task.name])
                    ])
                );
                addSection(`Room: ${section.name}`, taskDetails);
            });
            
            // Signature
            if (signatureDataURL) {
                addSection('Customer Signature', [
                    h('img', { src: signatureDataURL, class: 'w-full h-auto bg-white border' })
                ]);
            }
            
            // Show modal
            document.getElementById('details-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('details-modal-content').classList.add('scale-100'), 10);
        },
        
        closeModal() {
            document.getElementById('details-modal-content').classList.remove('scale-100');
            setTimeout(() => document.getElementById('details-modal').classList.add('hidden'), 300);
        }
    };
    
    // --- (LOGIN LOGIC) ---
    window.addEventListener('DOMContentLoaded', () => {
        const loginOverlay = document.getElementById('login-overlay');
        const appContainer = document.getElementById('app-container');
        const unlockButton = document.getElementById('unlock-button');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const errorMsg = document.getElementById('error-msg');

        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log("Firebase Initialized.");
            
            // Listen for login state
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is logged in
                    loginOverlay.classList.add('opacity-0');
                    setTimeout(() => { loginOverlay.style.display = 'none'; }, 300); 
                    appContainer.classList.remove('hidden');
                    setTimeout(() => appContainer.classList.remove('opacity-0'), 50);
                    
                    document.getElementById('user-email').textContent = user.email;
                    App.init(); // Start the main app
                } else {
                    // User is logged out
                    loginOverlay.style.display = 'flex';
                    loginOverlay.classList.remove('opacity-0');
                    appContainer.classList.add('hidden');
                    appContainer.classList.add('opacity-0');
                    
                    if (unsubscribe) unsubscribe(); // Stop listening to DB
                }
            });

            // Login button action
            unlockButton.onclick = () => {
                const email = emailInput.value;
                const pass = passwordInput.value;
                
                if (!email || !pass) {
                    errorMsg.textContent = 'Please enter email and password.';
                    errorMsg.classList.remove('hidden');
                    return;
                }
                
                errorMsg.classList.add('hidden');
                
                auth.signInWithEmailAndPassword(email, pass)
                    .then(userCredential => {
                        // Signed in, onAuthStateChanged will handle the rest
                        console.log('Login successful');
                    })
                    .catch(error => {
                        errorMsg.textContent = error.message;
                        errorMsg.classList.remove('hidden');
                        loginOverlay.querySelector('div').classList.add('animate-shake');
                        setTimeout(() => loginOverlay.querySelector('div').classList.remove('animate-shake'), 500);
                    });
            };
            
            passwordInput.onkeyup = (e) => {
                errorMsg.classList.add('hidden');
                if (e.key === 'Enter') unlockButton.click();
            };

        } catch (e) {
            console.error("Critical Error: ", e);
            document.body.innerHTML = `<h2 style='text-align: center; margin-top: 50px; color: red;'>Error: App failed to load. Check internet.</h2><p style='text-align:center'>${e.message}</p>`;
        }
    });
</script>

</body>
</html>
